name: Build iOS Simulator App (no signing)

on:
  workflow_dispatch:

jobs:
  ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Prebuild iOS
        run: npx expo prebuild --platform ios --no-install

      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: Build for iOS Simulator (.app)
        run: |
          set -e
          cd ios
          WORKSPACE=$(ls *.xcworkspace | head -n 1)
          SCHEME=$(xcodebuild -list -json -workspace "$WORKSPACE" | ruby -rjson -e 'puts JSON.parse(STDIN.read)["workspace"]["schemes"][0]')
          DEST="platform=iOS Simulator,name=iPhone 15"

          echo "Workspace: $WORKSPACE"
          echo "Scheme: $SCHEME"
          echo "Dest: $DEST"

          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "$DEST" \
            -derivedDataPath "$PWD/build/DerivedData" \
            clean build

          APP_PATH=$(find "$PWD/build/DerivedData/Build/Products" -maxdepth 3 -type d -name "*.app" | head -n 1)
          echo "Found app at: $APP_PATH"

          mkdir -p "$PWD/build/artifacts"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$PWD/build/artifacts/ios-sim-app.zip"

      # Optional: also produce an .xcarchive (still no device IPA export)
      - name: Create xcarchive (no export)
        run: |
          set -e
          cd ios
          WORKSPACE=$(ls *.xcworkspace | head -n 1)
          SCHEME=$(xcodebuild -list -json -workspace "$WORKSPACE" | ruby -rjson -e 'puts JSON.parse(STDIN.read)["workspace"]["schemes"][0]')
          DEST="generic/platform=iOS Simulator"

          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "$DEST" \
            -archivePath "$PWD/build/App.xcarchive" \
            clean archive || true

          if [ -d "$PWD/build/App.xcarchive" ]; then
            ditto -c -k --sequesterRsrc --keepParent "$PWD/build/App.xcarchive" "$PWD/build/artifacts/App.xcarchive.zip"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: ios/build/artifacts/*
